# 技术架构设计

> 公平、透明、可扩展的开源外卖平台架构

## 🏗️ 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户层                                  │
│  ┌───────────┐  ┌──────────┐  ┌────────────┐  ┌──────────────┐  │
│  │消费者小程序│  │骑手APP   │  │商家管理后台│  │运营管理后台  │  │
│  └───────────┘  └──────────┘  └────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      API 网关层 (Kong/Nginx)                    │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐                 │
│  │认证鉴权    │  │限流熔断    │  │请求路由    │                  │
│  └────────────┘  └────────────┘  └────────────┘                 │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      业务服务层 (Spring Boot)                    │
│  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────────┐   │
│  │用户服务│ │商家服务│ │商品服务│ │订单服务│ │派单引擎    │   │
│  └────────┘ └────────┘ └────────┘ └────────┘ └────────────┘   │
│  ┌────────┐ ┌────────┐ ┌────────┐ ┌──────────────────────┐   │
│  │支付服务│ │消息服务│ │数据服务│ │算法服务(透明公开)    │   │
│  └────────┘ └────────┘ └────────┘ └──────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       数据存储层                                 │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌──────────────────┐  │
│  │MySQL    │  │Redis    │  │MongoDB  │  │Elasticsearch    │  │
│  │(核心业务)│  │(缓存)   │  │(日志)   │  │(搜索/数据分析)  │  │
│  └─────────┘  └─────────┘  └─────────┘  └──────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      基础设施层                                  │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────┐   │
│  │Kubernetes│  │Docker    │  │CI/CD     │  │监控系统      │   │
│  │(编排)    │  │(容器)    │  │(GitHub)  │  │(Prometheus)  │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

## 📦 服务拆分

### 核心服务 (Core Services)

| 服务名 | 技术栈 | 职责 | 数据库 |
|--------|--------|------|--------|
| user-service | Spring Boot | 用户注册登录、认证鉴权、权限管理 | MySQL |
| merchant-service | Spring Boot | 商家入驻、店铺管理、营业状态 | MySQL |
| product-service | Spring Boot | 商品管理、分类管理、库存管理 | MySQL |
| order-service | Spring Boot | 订单创建、状态流转、订单查询 | MySQL |
| payment-service | Spring Boot | 支付对接、退款处理、账务管理 | MySQL |

### 算法服务 (Algorithm Services) - 透明公开

| 服务名 | 技术栈 | 职责 | 透明度 |
|--------|--------|------|--------|
| dispatch-service | Python/Java | 智能派单算法，公平合理 | 完全开源 |
| pricing-service | Python/Java | 动态定价算法 | 完全开源 |
| route-service | Python/Java | 路线规划算法 | 完全开源 |
| recommendation | Python/Java | 推荐算法 | 完全开源 |

### 支撑服务 (Support Services)

| 服务名 | 技术栈 | 职责 |
|--------|--------|------|
| notification-service | Spring Boot | 消息推送(短信/邮件/App推送) |
| data-service | Spring Boot | 数据统计、报表生成 |
| gateway-service | Spring Cloud Gateway | API网关、路由、限流 |
| admin-service | Spring Boot | 后台管理功能 |

### 前端应用 (Frontend)

| 应用 | 技术栈 | 平台 |
|------|--------|------|
| consumer-app | Taro/React Native | 微信小程序 + App |
| rider-app | Taro/React Native | 微信小程序 + App |
| merchant-app | React + Ant Design | Web管理后台 |
| admin-web | React + Ant Design Pro | 运营管理后台 |

## 🔐 关键技术选型

### 后端
- **语言**: Java 17 + Go (算法服务)
- **框架**: Spring Boot 3.x + Spring Cloud
- **ORM**: MyBatis-Plus
- **注册中心**: Nacos
- **配置中心**: Nacos
- **服务网格**: Spring Cloud Gateway

### 算法服务
- **Python**: NumPy + SciPy + NetworkX
- **机器学习**: scikit-learn (可解释模型)
- **路线规划**: OSRM + GraphHopper

### 数据存储
- **关系型**: MySQL 8.0 (主从)
- **缓存**: Redis 7.x (Cluster)
- **文档**: MongoDB
- **搜索**: Elasticsearch 8.x
- **消息队列**: Kafka

### 基础设施
- **容器化**: Docker
- **编排**: Kubernetes (K8s)
- **CI/CD**: GitHub Actions
- **监控**: Prometheus + Grafana + ELK
- **日志**: Loki + Grafana

## 🔄 核心业务流程

```
1. 用户下单流程
   用户选择商品 → 提交订单 → 支付 → 订单创建 → 派单 → 骑手接单 → 配送 → 完成

2. 商家入驻流程
   提交资料 → 资质审核 → 店铺设置 → 商品上架 → 开始营业

3. 骑手接单流程
   注册认证 → 状态上线 → 接收派单 → 确认接单 → 取餐 → 配送 → 完成
```

## 🛡️ 系统特性

### 公平性设计
- 派单算法完全透明，可解释
- 骑手单量上限，防止过度劳动
- 价格算法公开，不搞大数据杀熟
- 商家抽佣透明可控

### 可扩展性
- 微服务架构，按需扩展
- 水平扩展能力
- 多城市部署支持

### 安全性
- 数据加密传输
- 隐私数据脱敏
- 操作日志审计
- 区块链存证（派单记录）

---

*文档版本：v1.0.0*
*最后更新：2025-01-31*

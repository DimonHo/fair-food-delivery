# 技术架构设计

> 公平、透明、可扩展的开源外卖平台架构

## 🏗️ 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户层                                  │
│  ┌───────────┐  ┌──────────┐  ┌────────────┐  ┌──────────────┐  │
│  │消费者小程序│  │骑手APP   │  │商家管理后台│  │运营管理后台  │  │
│  └───────────┘  └──────────┘  └────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      API 网关层 (Kong/Nginx)                    │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐                 │
│  │认证鉴权    │  │限流熔断    │  │请求路由    │                  │
│  └────────────┘  └────────────┘  └────────────┘                 │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      业务服务层 (Spring Boot)                    │
│  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────────┐   │
│  │用户服务│ │商家服务│ │商品服务│ │订单服务│ │派单引擎    │   │
│  └────────┘ └────────┘ └────────┘ └────────┘ └────────────┘   │
│  ┌────────┐ ┌────────┐ ┌────────┐ ┌──────────────────────┐   │
│  │支付服务│ │消息服务│ │数据服务│ │算法服务(透明公开)    │   │
│  └────────┘ └────────┘ └────────┘ └──────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       数据存储层                                 │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌──────────────────┐  │
│  │MySQL    │  │Redis    │  │MongoDB  │  │Elasticsearch    │  │
│  │(核心业务)│  │(缓存)   │  │(日志)   │  │(搜索/数据分析)  │  │
│  └─────────┘  └─────────┘  └─────────┘  └──────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      基础设施层                                  │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────┐   │
│  │Kubernetes│  │Docker    │  │CI/CD     │  │监控系统      │   │
│  │(编排)    │  │(容器)    │  │(GitHub)  │  │(Prometheus)  │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

## 📦 服务拆分

### 核心服务 (Core Services)

| 服务名 | 技术栈 | 职责 | 数据库 |
|--------|--------|------|--------|
| user-service | Spring Boot | 用户注册登录、认证鉴权、权限管理 | MySQL |
| merchant-service | Spring Boot | 商家入驻、店铺管理、营业状态 | MySQL |
| product-service | Spring Boot | 商品管理、分类管理、库存管理 | MySQL |
| order-service | Spring Boot | 订单创建、状态流转、订单查询 | MySQL |
| payment-service | Spring Boot | 支付对接、退款处理、账务管理 | MySQL |

### 算法服务 (Algorithm Services) - 透明公开

| 服务名 | 技术栈 | 职责 | 透明度 |
|--------|--------|------|--------|
| dispatch-service | Python/Java | 智能派单算法，公平合理 | 完全开源 |
| pricing-service | Python/Java | 动态定价算法 | 完全开源 |
| route-service | Python/Java | 路线规划算法 | 完全开源 |
| recommendation | Python/Java | 推荐算法 | 完全开源 |

### 支撑服务 (Support Services)

| 服务名 | 技术栈 | 职责 |
|--------|--------|------|
| notification-service | Spring Boot | 消息推送(短信/邮件/App推送) |
| data-service | Spring Boot | 数据统计、报表生成 |
| gateway-service | Spring Cloud Gateway | API网关、路由、限流 |
| admin-service | Spring Boot | 后台管理功能 |

### 前端应用 (Frontend)

| 应用 | 技术栈 | 平台 |
|------|--------|------|
| consumer-app | Taro/React Native | 微信小程序 + App |
| rider-app | Taro/React Native | 微信小程序 + App |
| merchant-app | React + Ant Design | Web管理后台 |
| admin-web | React + Ant Design Pro | 运营管理后台 |

## 🔐 关键技术选型

### 后端
- **语言**: Java 17 + Go (算法服务)
- **框架**: Spring Boot 3.x + Spring Cloud
- **ORM**: MyBatis-Plus
- **注册中心**: Nacos
- **配置中心**: Nacos
- **服务网格**: Spring Cloud Gateway

### 算法服务
- **Python**: NumPy + SciPy + NetworkX
- **机器学习**: scikit-learn (可解释模型)
- **路线规划**: OSRM + GraphHopper

### 数据存储
- **关系型**: MySQL 8.0 (主从)
- **缓存**: Redis 7.x (Cluster)
- **文档**: MongoDB
- **搜索**: Elasticsearch 8.x
- **消息队列**: Kafka

### 基础设施
- **容器化**: Docker
- **编排**: Kubernetes (K8s)
- **CI/CD**: GitHub Actions
- **监控**: Prometheus + Grafana + ELK
- **日志**: Loki + Grafana

## 🔄 核心业务流程

```
1. 用户下单流程
   用户选择商品 → 提交订单 → 支付 → 订单创建 → 派单 → 骑手接单 → 配送 → 完成

2. 商家入驻流程
   提交资料 → 资质审核 → 店铺设置 → 商品上架 → 开始营业

3. 骑手接单流程
   注册认证 → 状态上线 → 接收派单 → 确认接单 → 取餐 → 配送 → 完成
```

## 🛡️ 系统特性

### 公平性设计
- 派单算法完全透明，可解释
- 骑手单量上限，防止过度劳动
- 价格算法公开，不搞大数据杀熟
- 商家抽佣透明可控

### 可扩展性
- 微服务架构，按需扩展
- 水平扩展能力
- 多城市部署支持

### 安全性
- 数据加密传输
- 隐私数据脱敏
- 操作日志审计
- 区块链存证（派单记录）

## 📊 容量规划与用户规模预估

### 业务阶段规划

| 阶段 | 时间周期 | 目标用户 | 日订单量 | 峰值QPS |
|------|----------|----------|----------|---------|
| MVP | 1-3个月 | 1,000 | 100 | 50 |
| 种子期 | 3-6个月 | 10,000 | 1,000 | 500 |
| 成长期 | 6-12个月 | 100,000 | 10,000 | 5,000 |
| 成熟期 | 1-2年 | 1,000,000 | 100,000 | 50,000 |
| 规模化 | 2年以上 | 10,000,000+ | 1,000,000+ | 500,000+ |

### 各阶段资源配置

#### MVP 阶段（单节点）
```
服务器配置:
- 应用服务器: 2核 4GB
- 数据库: 4核 8GB (MySQL)
- 缓存: 2核 4GB (Redis)
- 存储: 50GB SSD

预估月成本: $50-100
```

#### 种子期（3节点集群）
```
服务器配置:
- 应用服务器: 3 × (2核 4GB)
- 数据库主从: 2 × (4核 16GB)
- 缓存集群: 3 × (2核 8GB)
- 存储: 200GB SSD

预估月成本: $200-400
```

#### 成长期（多可用区）
```
服务器配置:
- 应用服务器: 10 × (4核 8GB)
- 数据库主从: 2 × (8核 32GB)
- 缓存集群: 6 × (4核 16GB)
- 消息队列: 3 × (2核 4GB)
- 存储: 1TB SSD

预估月成本: $1,000-2,000
```

#### 成熟期（多地域部署）
```
服务器配置:
- 应用服务器: 50 × (8核 16GB)
- 数据库集群: 6 × (16核 64GB)
- 缓存集群: 20 × (8核 32GB)
- 消息队列: 10 × (4核 8GB)
- 搜索引擎: 6 × (8核 32GB)
- 存储: 10TB SSD

预估月成本: $5,000-10,000
```

### 核心接口性能要求

| 接口 | MVP | 种子期 | 成长期 | 成熟期 |
|------|-----|--------|--------|--------|
| 首页加载 | <1s | <500ms | <200ms | <100ms |
| 下单创建 | <2s | <1s | <500ms | <200ms |
| 派单计算 | <3s | <1s | <200ms | <100ms |
| 订单列表 | <1s | <500ms | <200ms | <100ms |

### 高并发场景预估

#### 高峰期流量
- **午餐高峰 (11:00-13:00)**: 峰值流量是平时的 5-10 倍
- **晚餐高峰 (17:00-20:00)**: 峰值流量是平时的 3-5 倍
- **恶劣天气**: 峰值流量可能达到平时的 15 倍

#### 系统扩容策略
```
1. 水平扩展
   - 应用服务: 根据 CPU > 70% 自动扩容
   - 最小实例: 2, 最大实例: 100

2. 限流降级
   - 令牌桶算法限流
   - 非核心接口降级处理

3. 缓存策略
   - 多级缓存 (本地 + Redis)
   - 热点数据预热
   - 缓存雪崩防护

4. 异步处理
   - 订单日志: 异步写入
   - 数据统计: 定时汇总
   - 消息推送: 消息队列削峰
```

### 存储容量规划

| 数据类型 | 日增量 | 单条大小 | 1年存储 | 3年存储 |
|----------|--------|----------|---------|---------|
| 用户行为日志 | 10GB | 1KB | 3.6TB | 10.8TB |
| 订单数据 | 1GB | 5KB | 360GB | 1TB |
| 商品图片 | 500MB | 500KB | 180GB | 500GB |
| 派单记录 | 500MB | 2KB | 180GB | 500GB |
| **总计** | **12GB** | - | **4.3TB** | **12.8TB** |

### 数据库分片策略

#### 订单表分片（按用户ID）
```sql
-- 水平分片策略
-- 分片键: user_id
-- 分片算法: range/hash

-- 初期: 单库单表
-- 成长期: 4库16表
-- 成熟期: 16库256表
```

#### 商家数据分片（按城市）
```sql
-- 地理分片策略
-- 分片键: city_code
-- 按城市划分数据分区
```

### 监控告警指标

| 指标 | 预警阈值 | 严重阈值 | 紧急阈值 |
|------|----------|----------|----------|
| CPU 使用率 | >70% | >85% | >95% |
| 内存使用率 | >75% | >85% | >95% |
| 接口响应时间 | >500ms | >1s | >3s |
| 错误率 | >1% | >5% | >10% |
| 数据库连接数 | >70% | >85% | >95% |

### 成本控制策略

1. **按需扩容**: 只在高峰期扩容
2. **混部策略**: 非核心服务使用低价实例
3. **存储分层**: 热数据 SSD，温数据 HDD，冷数据归档
4. **资源复用**: 共享服务减少重复部署

---

*文档版本：v1.1.0*
*最后更新：2025-01-31*
